"use strict";(self.webpackChunkipc144=self.webpackChunkipc144||[]).push([[3991],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(n),h=i,m=c["".concat(l,".").concat(h)]||c[h]||d[h]||o;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:i,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},1831:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));n(8209);const o={id:"pre-built-libraries-solutions",title:"Pre-Built Libraries / Solutions",sidebar_position:3,description:"Pre-Built Libraries / Solutions"},r="Pre-Built Libraries / Solutions",s={unversionedId:"Authentication-In-Next/pre-built-libraries-solutions",id:"Authentication-In-Next/pre-built-libraries-solutions",title:"Pre-Built Libraries / Solutions",description:"Pre-Built Libraries / Solutions",source:"@site/docs/Authentication-In-Next/pre-built-libraries-solutions.md",sourceDirName:"Authentication-In-Next",slug:"/Authentication-In-Next/pre-built-libraries-solutions",permalink:"/Authentication-In-Next/pre-built-libraries-solutions",draft:!1,editUrl:"hhttps://github.com/patrick-crawford/WebProgrammingForAppsAndServices/tree/master/docs/Authentication-In-Next/pre-built-libraries-solutions.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"pre-built-libraries-solutions",title:"Pre-Built Libraries / Solutions",sidebar_position:3,description:"Pre-Built Libraries / Solutions"},sidebar:"courseNotesSidebar",previous:{title:"UI Considerations",permalink:"/Authentication-In-Next/UI-considerations"},next:{title:"Example Code",permalink:"/Authentication-In-Next/example-code"}},l={},p=[{value:"Iron-Session",id:"iron-session",level:2},{value:"Example Code",id:"example-code",level:3},{value:"Exercise: Add a Protected Route",id:"exercise-add-a-protected-route",level:4},{value:"NextAuth.js",id:"nextauthjs",level:2},{value:"Example Code",id:"example-code-1",level:3},{value:"Enabling Authentication",id:"enabling-authentication",level:4},{value:"Exercise: Add a Protected Route",id:"exercise-add-a-protected-route-1",level:4}],u={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,i.kt)(c,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"pre-built-libraries--solutions"},"Pre-Built Libraries / Solutions"),(0,i.kt)("p",null,"Before moving on to the next topic, we should quickly introduce two of the 3rd party ",(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/authentication#authentication-providers"},'"authentication providers"')," suggested in the Next.js documentation:"),(0,i.kt)("h2",{id:"iron-session"},"Iron-Session"),(0,i.kt)("p",null,"From the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/vvo/iron-session#readme"},'"Iron-Session" Documentation'),", this package is described as:"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Node.js stateless session utility using signed and encrypted cookies to store data. Works with Next.js, Express, NestJs, Fastify, and any Node.js HTTP framework."),(0,i.kt)("p",{parentName:"blockquote"},'The session data is stored in encrypted cookies ("seals"). And only your server can decode the session data. There are no session ids, making iron sessions "stateless" from the server point of view.'),(0,i.kt)("p",{parentName:"blockquote"},"This strategy of storing session data is the same technique used by frameworks like ",(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("a",{parentName:"strong",href:"https://guides.rubyonrails.org/security.html#session-storage"},"Ruby On Rails"))," (their default strategy)."),(0,i.kt)("p",{parentName:"blockquote"},"The underlying cryptography library is ",(0,i.kt)("a",{parentName:"p",href:"https://hapi.dev/module/iron"},"iron")," which was ",(0,i.kt)("a",{parentName:"p",href:"https://hueniversedotcom.wordpress.com/2015/09/19/auth-to-see-the-wizard-or-i-wrote-an-oauth-replacement/"},"created by the lead developer of OAuth 2.0."))),(0,i.kt)("p",null,"To get started using iron-session, you can use the next.js example from their ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/vvo/iron-session/tree/main/examples"},"GitHub repository"),"."),(0,i.kt)("h3",{id:"example-code"},"Example Code"),(0,i.kt)("p",null,'If we open the "next.js" folder from within the "examples" folder from the above repository, we should see the code for a typical Next.js app including a "components" folder containing reusable components such as "Header", "Layout", etc., as well as a number of "page" and "API" routes under the "pages" folder. Additionally, you will find a "lib" folder containing files that help to define session options as well as ',(0,i.kt)("a",{parentName:"p",href:"https://react.dev/learn/reusing-logic-with-custom-hooks"},"custom Hooks")," used fetch user information, etc."),(0,i.kt)("p",null,"To get this example running, execute ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install"),' to obtain the dependencies / rebuild the "node_modules" folder. You are then free to start the app using the familiar ',(0,i.kt)("inlineCode",{parentName:"p"},"npm run dev")," command."),(0,i.kt)("p",null,'You will notice that this is a complete example and does not require any configuration. A "SECRET_COOKIE_PASSWORD" value has been placed in ".env.development" as well as ".env.production". However, it is stated:'),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"The SECRET_COOKIE_PASSWORD should never be inside your repository directly, it's here only to ease the example deployment. For local development, you should store it inside a ",(0,i.kt)("inlineCode",{parentName:"p"},".env.local")," gitignored file. See ",(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/basic-features/environment-variables#loading-environment-variables"},"https://nextjs.org/docs/basic-features/environment-variables#loading-environment-variables"))),(0,i.kt)("p",null,'To "Login" all that is required is that you enter a ',(0,i.kt)("em",{parentName:"p"},"valid")," github username."),(0,i.kt)("h4",{id:"exercise-add-a-protected-route"},"Exercise: Add a Protected Route"),(0,i.kt)("p",null,'We will not go into detail about how to configure and/or modify this example. However, it would be valuable to see what is involved in creating an additional page that is "protected" (only accessible after logging in) and has access to the logged in user:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Create a new Page, ie "/pages/protectedTest.js"')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the following Component Logic (used to display the user's login and avatar image)"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},'import Layout from "components/Layout";\nimport useUser from "lib/useUser";\n\nexport default function ProtectedTest() {\n  const { user } = useUser({\n    redirectTo: "/login",\n  });\n\n  return (\n    <Layout>\n      <h1>Protected Test</h1>\n      {user && (\n        <>\n          <p><strong>User: </strong> {user.login}</p>\n          <img src={user.avatarUrl || ""} alt="avatar" />\n        </>\n      )}\n    </Layout>\n  );\n}\n')),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Add A link in the Header (components/Header.js)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},'{user?.isLoggedIn === true && (\n  <li>\n    <Link href="/protectedTest" legacyBehavior>\n      <a>Protected Test</a>\n    </Link>\n  </li>\n)}\n')),(0,i.kt)("p",null,'Once you have added the above code, refresh the app to see the changes; "Protected Test" should only be accessible / visible in the Header once the user has logged in!'),(0,i.kt)("h2",{id:"nextauthjs"},"NextAuth.js"),(0,i.kt)("p",null,'The second example that we will discuss is "NextAuth.js", described by Next.js as "a full-featured authentication system with built-in providers (Google, Facebook, GitHub\u2026), JWT, JWE, email/password, magic links and more". It has ',(0,i.kt)("a",{parentName:"p",href:"https://next-auth.js.org/"},"extensive documentation"),", including video tutorials."),(0,i.kt)("p",null,"To begin working with NextAuth, you can once again use the Example Code from their ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/nextauthjs/next-auth-example"},"GitHub repository"),"."),(0,i.kt)("h3",{id:"example-code-1"},"Example Code"),(0,i.kt)("p",null,"Once you have obtained the example code, you must once again execute the command ",(0,i.kt)("inlineCode",{parentName:"p"},"npm install"),' to rebuild the "node_modules" folder. Once this is complete, you can run the app with ',(0,i.kt)("inlineCode",{parentName:"p"},"npm run dev"),"."),(0,i.kt)("p",null,"Again, this is a complete example with a ton of code including 8 pages, API routes, custom components and configurations. It also makes use of the (now stable) ",(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/advanced-features/middleware"},"Middleware"),' functionality, as seen in the "middleware.ts" file.'),(0,i.kt)("p",null,'You will also notice that there is a .tsconfig file, and the file extensions of components and other files containing code use the extensions ".tsx" and ".ts". This is because this particular Next.js app has been created using ',(0,i.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/api-reference/create-next-app"},"the --ts flag"),", ie: ",(0,i.kt)("inlineCode",{parentName:"p"},"npx create-next-app my-app --ts --use-npm")," and uses ",(0,i.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/"},"TypeScript"),"."),(0,i.kt)("p",null,"If you attempt to run the app at this point, you will notice a page with a large heading reading ",(0,i.kt)("strong",{parentName:"p"},'"NextAuth.js Example"'),' as well as links to various public and private routes such as "/client", "/server", "/protected", "/admin" etc. Most notably however, is a section at the top that states: "You are not signed in" next to a large blue button with the text "Sign in". If you click this button, you will be directed to "/api/auth/signin" and presented with various sign in options. Unfortunately, at the moment, none of them are functioning and will result in a warning: "Try signing in with a different account."'),(0,i.kt)("h4",{id:"enabling-authentication"},"Enabling Authentication"),(0,i.kt)("p",null,'As we have seen, there is currently no way of logging into the app, since none of the providers ("Facebook", "GitHub", "Google", etc.) have been configured.'),(0,i.kt)("p",null,"To remedy this, let's create a GitHub Authentication Provider. This will allow users to log in using their GitHub credentials without having to explicitly create an account with our app:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"To begin, login to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/"},"GitHub"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Next, navigate to the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/settings/developers"},'"Developer Settings"'),' - available under the user menu / settings / "Developer Settings"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Click "OAuth Apps" in the sidebar')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Click the green "Register a new application" button')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"At the next screen, fill in the available fields as:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Application name:")," Your application name - This can be anything you like.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Homepage URL:")," This is the full URL to the homepage of our app. Since we are still in development, we are going to use the full URL for our server running locally, ie: ",(0,i.kt)("strong",{parentName:"p"},"http://localhost:3000"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"Authorization callback URL:")," This is the URL that GitHub will redirect our users to after they have successfully logged in. It must be your homepage URL plus /api/auth/callback, ie: ",(0,i.kt)("strong",{parentName:"p"},"http://localhost:3000/api/auth/callback"))))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Once this is complete, click on "Register application"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"At the next page, copy your ",(0,i.kt)("strong",{parentName:"p"},'"Client ID"')," value (we will need this later) and click ",(0,i.kt)("strong",{parentName:"p"},'"Generate a new client secret"')," and ",(0,i.kt)("strong",{parentName:"p"},"copy it immediately")," (you won't be able to see it again)"),(0,i.kt)("blockquote",{parentName:"li"},(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"NOTE"),": For more information on using OAuth with GitHub, see the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/developers/apps/building-oauth-apps"},'official GitHub documentation on "Building OAuth Apps"'))))),(0,i.kt)("p",null,"With your application registered, we can now add the client ID / Secret values to the configuration of our NextAuth demo app:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Rename the file "env.local.example" to "env.local"')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Remove all environment variables except:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"NEXTAUTH_URL"),(0,i.kt)("li",{parentName:"ul"},"NEXTAUTH_SECRET"),(0,i.kt)("li",{parentName:"ul"},"GITHUB_ID"),(0,i.kt)("li",{parentName:"ul"},"GITHUB_SECRET"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Fill in the values of:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},'"GITHUB_ID" using your "Client ID" (from above)'),(0,i.kt)("li",{parentName:"ul"},'"GITHUB_SECRET" using your "client secret" (from above)'),(0,i.kt)("li",{parentName:"ul"},'"NEXTAUTH_SECRET" can be obtained by either using the command ',(0,i.kt)("inlineCode",{parentName:"li"},"openssl rand -hex 32")," or visiting ",(0,i.kt)("a",{parentName:"li",href:"https://generate-secret.now.sh/32"},"https://generate-secret.now.sh/32"))))),(0,i.kt)("p",null,'Once you have completed updating the environment variables in your new "env.local" file, you may try restarting the app and attempting to log in using your GitHub account (',(0,i.kt)("strong",{parentName:"p"},"NOTE:")," If you are still logged in to GitHub in another tab, log out first, and try logging in using just the app)"),(0,i.kt)("h4",{id:"exercise-add-a-protected-route-1"},"Exercise: Add a Protected Route"),(0,i.kt)("p",null,'With our NextAuth demo now functioning correctly using our GitHub OAuth provider, we can see what is involved in creating a "Protected" route:'),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'Create a new Page, ie "/pages/protectedTest.tsx"')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Add the following Component Logic (used to display the user's name and avatar image)"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},'import { useSession } from "next-auth/react"\nimport Layout from "../components/layout"\nimport AccessDenied from "../components/access-denied"\n\nexport default function ProtectedPage() {\n  const { data: session, status } = useSession()\n  \n  // If no session exists, display access denied message\n  if (!session) {\n    return (\n      <Layout>\n        <AccessDenied />\n      </Layout>\n    )\n  }\n\n  // If session exists, display content\n  return (\n  <Layout>\n      <h1>Protected Test</h1>\n      {session.user && (\n        <>\n          <p><strong>User: </strong> {session.user.name}</p>\n          <img src={session.user.image || ""} alt="avatar" />\n        </>\n      )}\n    </Layout>\n  );\n}\n')),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Add a link in the Header (components/header.tsx)")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-jsx"},'<li className={styles.navItem}>\n  <Link href="/protectedTest" legacyBehavior>\n    <a>Protected Test</a>\n  </Link>\n</li>\n')),(0,i.kt)("p",null,'Once you have added the above code, refresh the app to see the changes; "Protected Test" should only be accessible once the user has logged in.'))}d.isMDXComponent=!0},8209:(e,t,n)=>{n(7294)}}]);