"use strict";(self.webpackChunkipc144=self.webpackChunkipc144||[]).push([[2044],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=p(n),d=a,m=c["".concat(l,".").concat(d)]||c[d]||h[d]||s;return n?r.createElement(m,o(o({ref:t},u),{},{components:n})):r.createElement(m,o({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=d;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[c]="string"==typeof e?e:a,o[1]=i;for(var p=2;p<s;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4199:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var r=n(7462),a=(n(7294),n(3905));n(8209);const s={id:"web-api-with-authentication",title:"Web API With Authentication",sidebar_position:1,description:"Web API With Authentication"},o="Web API With Authentication",i={unversionedId:"Introduction-JWT/web-api-with-authentication",id:"Introduction-JWT/web-api-with-authentication",title:"Web API With Authentication",description:"Web API With Authentication",source:"@site/docs/Introduction-JWT/web-api-with-authentication.md",sourceDirName:"Introduction-JWT",slug:"/Introduction-JWT/web-api-with-authentication",permalink:"/Introduction-JWT/web-api-with-authentication",draft:!1,editUrl:"hhttps://github.com/patrick-crawford/WebProgrammingForAppsAndServices/tree/master/docs/Introduction-JWT/web-api-with-authentication.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"web-api-with-authentication",title:"Web API With Authentication",sidebar_position:1,description:"Web API With Authentication"},sidebar:"courseNotesSidebar",previous:{title:"Example Code",permalink:"/Managing-Application-State/example-code"},next:{title:"JSON Web Tokens (JWT)",permalink:"/Introduction-JWT/json-web-tokens-jwt"}},l={},p=[{value:"Quick note on &quot;CORS&quot;",id:"quick-note-on-cors",level:2},{value:"Account Management &amp; Security",id:"account-management--security",level:2},{value:"MongoDB Atlas &amp; MongoDB",id:"mongodb-atlas--mongodb",level:3},{value:"Updating the &quot;user-service&quot;",id:"updating-the-user-service",level:3},{value:"Hashed Passwords with bcrypt (bcryptjs)",id:"hashed-passwords-with-bcrypt-bcryptjs",level:3},{value:"Adding &amp; Testing Authentication Routes",id:"adding--testing-authentication-routes",level:3}],u={toc:p},c="wrapper";function h(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"web-api-with-authentication"},"Web API With Authentication"),(0,a.kt)("p",null,"Before we can begin learning about JWT and how to secure a Web API, we must first create a simple Node.js server to handle our API requests. To speed this along, we have included a simple Web API in the ",(0,a.kt)("a",{parentName:"p",href:"/Introduction-JWT/example-code"},"Example Code"),' for this week (See the "simple-API" folder). Currently, the primary function of this Web API is to return a hard-coded, static list of vehicles from its data-service.js module, using the route "/api/vehicles".'),(0,a.kt)("p",null,'Once you have extracted the "simple-API" folder from the example code, open it in Visual Studio Code and execute the following command to fetch the dependencies (currently, only ',(0,a.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/express"},"express")," & ",(0,a.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/cors"},"cors"),"):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"npm install\n")),(0,a.kt)("p",null,"Once this is complete, execute the command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"node server.js\n")),(0,a.kt)("p",null,'This will start the server server and enable you to test the "/api/vehicles" route on localhost:8080. You should see an array of JSON objects, consisting of 5 vehicles.'),(0,a.kt)("h2",{id:"quick-note-on-cors"},'Quick note on "CORS"'),(0,a.kt)("p",null,'At this point, you may be asking "What is \'cors\' and why do we need this module?". CORS stands for "Cross-Origin Resource Sharing" and it is essentially a way to enable JavaScript to make an AJAX call from one origin (domain) to a server on a ',(0,a.kt)("strong",{parentName:"p"},"different")," domain. This is not permitted by default, as browsers restrict these types of requests for security reasons. If we did not enable CORS, we could not use AJAX to make requests from our localhost to our API, if our API is running online."),(0,a.kt)("p",null,'In addition to simply allowing all AJAX requests from outside domains, the CORS module also allows you to "whitelist" certain domains, thereby allowing access for specific domains, while restricting access from all others.'),(0,a.kt)("p",null,'More details can be found on MDN under "',(0,a.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS"},"Cross-Origin Resource Sharing (CORS)"),'" and the ',(0,a.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/cors"},'"cors" module on NPM')),(0,a.kt)("h2",{id:"account-management--security"},"Account Management & Security"),(0,a.kt)("p",null,'With our extremely simple "vehicles" API in place and producing data, we can now move on to discuss how we might ',(0,a.kt)("em",{parentName:"p"},"protect")," this data from unwanted (unauthorized) access. This will include creating routes that allow users to register accounts (persisted in MongoDB with encrypted passwords) as well as logging in to the system."),(0,a.kt)("h3",{id:"mongodb-atlas--mongodb"},"MongoDB Atlas & MongoDB"),(0,a.kt)("p",null,"As mentioned above, we will be persisting registered accounts using MongoDB in the cloud database platform: ",(0,a.kt)("a",{parentName:"p",href:"https://www.mongodb.com/cloud"},"MongoDB Atlas"),". If you're not familiar with MongoDB Atlas at this point, you may review the basic setup here:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("a",{parentName:"p",href:"https://www.mongodb.com/basics/mongodb-atlas-tutorial"},"MongoDB Atlas Tutorial"))),(0,a.kt)("p",null,'Once your cluster is up and running correctly (ie: A "Database User" has been created, IP Access is "Allowed from Anywhere", etc), set up a new "simple-API-users" database with a "users" collection for the simple API. Once this is done, obtain a copy of the connection string - this should look something like:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mongodb+srv://user:<password>@cluster0-abc1.mongodb.net/?retryWrites=true&w=majority\n")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"NOTE:")," You will have to add the text: ",(0,a.kt)("strong",{parentName:"p"},"simple-API-users")," in the above connection string after the last part of the url before the query parameters, ie: ",(0,a.kt)("strong",{parentName:"p"},"mongodb.net/simple-API-users"),". In addition, you must update the values for ",(0,a.kt)("strong",{parentName:"p"},"user")," and ",(0,a.kt)("strong",{parentName:"p"},"<","password",">"),' to match the credentials that you created for the "Database User".')),(0,a.kt)("p",null,"Be sure to keep track of your connection string, as we will be using it in the next piece:"),(0,a.kt)("h3",{id:"updating-the-user-service"},'Updating the "user-service"'),(0,a.kt)("p",null,'To keep our DB authentication piece clean, we will be making use of the promise-based "user-service" module, defined in the "user-service.js" file. If you open this file, you will see a space for your MongoDB connection string; enter it now before proceeding.'),(0,a.kt)("p",null,'Next, you will notice a definition for a "user" Schema (userSchema). In this case, it consists of 4 simple fields:'),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"userName:")," A (unique) string representing the user's login/user name")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"password:")," The user's password")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"fullName:")," Ths user's full name")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"role:"),' The user\'s role, ie "administrator", "data-entry", "maintenance", etc. (the user\'s role will define exactly what in the API the user has access to. For our example we will not be using this field, as every user will have access to all vehicles)'))),(0,a.kt)("p",null,"Below this, you should note that there are 3 exported functions:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"connect():"),' This function simply ensures that we can connect to the DB and if successful, assign the "User" object as a "User" model, using the "users" collection (specified by userSchema).')),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"registerUser(userData):")," Ensures that the provided passwords match and that the user name is not already taken. If the userData provided meets this criteria, add the user to the system.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("strong",{parentName:"p"},"checkUser(userData):"),' This function ensures that the user specified by "userData" is in the system and has the correct password (used for logging in)'))),(0,a.kt)("p",null,'Lastly, before we can move on to test the application (below) we must update our "server.js" to "connect" to our user service before we start the server, ie:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'userService.connect().then(()=>{\n  app.listen(HTTP_PORT, ()=>{console.log("API listening on: " + HTTP_PORT)});\n})\n.catch((err)=>{\n  console.log("unable to start the server: " + err);\n  process.exit();\n});\n')),(0,a.kt)("h3",{id:"hashed-passwords-with-bcrypt-bcryptjs"},"Hashed Passwords with bcrypt (bcryptjs)"),(0,a.kt)("p",null,"Up to this point, our user service has been designed to store passwords as plain text. This is a serious security concern as passwords must ",(0,a.kt)("strong",{parentName:"p"},"always")," be encrypted. To achieve this, we will be making use of the password-hashing function: ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Bcrypt"},'"bcrypt"'),"."),(0,a.kt)("p",null,"To include ",(0,a.kt)("em",{parentName:"p"},"bcrypt"),", we must install ",(0,a.kt)("strong",{parentName:"p"},"bcryptjs")," using ",(0,a.kt)("strong",{parentName:"p"},"npm"),' and "require" the module at the top of our user-service.js:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"const bcrypt = require('bcryptjs');\n")),(0,a.kt)("p",null,"Once we have the module, we can use the following logic to ",(0,a.kt)("strong",{parentName:"p"},"hash")," a password using bcrypt's ",(0,a.kt)("strong",{parentName:"p"},"hash()")," method, ie:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'// Encrypt the plain text: "myPassword123"\nbcrypt.hash(\'myPassword123\', 10).then((hash) => {\n  // Hash the password using a Salt that was generated using 10 rounds\n  // TODO: Store the resulting "hash" value in the DB\n});\n')),(0,a.kt)("p",null,'If we apply this process to our "registerUser" function (thereby ',(0,a.kt)("em",{parentName:"p"},"hashing")," the provided password when registering the user), our code will look like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'module.exports.registerUser = function (userData) {\n  return new Promise(function (resolve, reject) {\n\n    if (userData.password != userData.password2) {\n        reject("Passwords do not match");\n    } else {\n        bcrypt.hash(userData.password, 10).then(hash=>{ // Hash the password using a Salt that was generated using 10 rounds\n          \n          userData.password = hash;\n          let newUser = new User(userData);\n\n          newUser.save().then(() => {\n              resolve("User " + userData.userName + " successfully registered");\n          }).catch(err => {\n              if (err.code == 11000) {\n                  reject("User Name already taken");\n              } else {\n                  reject("There was an error creating the user: " + err);\n              }\n          });\n        }).catch(err => reject(err));\n    }\n  });\n};\n')),(0,a.kt)("p",null,"This makes the code a little longer and harder to follow, but we are really only adding the ",(0,a.kt)("strong",{parentName:"p"},"bcrypt.hash()")," method to our existing function."),(0,a.kt)("p",null,"If we wish to ",(0,a.kt)("strong",{parentName:"p"},"compare")," a plain text password to a ",(0,a.kt)("strong",{parentName:"p"},"hashed")," password, we can use bcrypt's ",(0,a.kt)("strong",{parentName:"p"},"compare()")," method with the following logic:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'// Pull the password "hash" value from the DB and compare it to "myPassword123" (match)\nbcrypt.compare(\'myPassword123\', hash).then((res) => {\n  // if res === true, the passwords match\n});\n')),(0,a.kt)("p",null,'If we apply this to our "checkUser" function (thereby comparing the DB\'s ',(0,a.kt)("em",{parentName:"p"},"hashed")," password with the provided password), our code will look like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'module.exports.checkUser = function (userData) {\n  return new Promise(function (resolve, reject) {\n\n    User.find({ userName: userData.userName })\n    .limit(1)\n    .exec()\n    .then((users) => {\n\n      if (users.length == 0) {\n        reject("Unable to find user " + userData.userName);\n      } else {\n        bcrypt.compare(userData.password, users[0].password).then((res) => {\n          if (res === true) {\n            resolve(users[0]);\n          } else {\n            reject("Incorrect password for user " + userData.userName);\n          }\n        });\n      }\n    }).catch((err) => {\n      reject("Unable to find user " + userData.userName);\n    });\n  });\n};\n')),(0,a.kt)("p",null,"Not much has changed here. Instead of simply comparing userData.password with users","[","0","]",".password directly, we use the ",(0,a.kt)("strong",{parentName:"p"},"bcrypt.compare()")," method."),(0,a.kt)("h3",{id:"adding--testing-authentication-routes"},"Adding & Testing Authentication Routes"),(0,a.kt)("p",null,'Now that we have a working "user" service that will handle registering and validating user information, we should add some new "/api/" authentication routes to add the functionality to our API.'),(0,a.kt)("p",null,'Since our new routes will be accepting input (via JSON, posted to the route), we will need to configure our server to correctly parse "JSON" formatted data. This can be accomplished by adding ',(0,a.kt)("a",{parentName:"p",href:"https://expressjs.com/en/api.html"},"express.json()")," built-in middleware before our route definitions:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"app.use(express.json());\n")),(0,a.kt)("p",null,'With the middleware correctly configured, we can reliably assume that the "body" property of the request (req) will contain the properties and values of the data sent from the AJAX request.'),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"NOTE:")," We do not yet have a UI to gather user information for registration and validation, so we must make use of an API testing tool such as the ",(0,a.kt)("a",{parentName:"p",href:"https://www.thunderclient.io/"},"Thunder Client Extension")," to make requests and provide POST data when testing our new routes.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"New Route: /api/register")),(0,a.kt)("p",null,"This route simply collects user registration information sent using POST to the API in the form of a JSON-formatted string, ie:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": "bob",\n  "password": "myPassword",\n  "password2": "myPassword",\n  "fullName": "Robert Wiley",\n  "role": "administrator"\n}\n')),(0,a.kt)("p",null,"Fortunately, our ",(0,a.kt)("strong",{parentName:"p"},"userService.registerUser()"),' function is perfectly set up to handle this type of data. It will validate whether password & password2 match and check that the user name "bob" is not taken. If the data meets these requirements, the provided password will be hashed and the user will be entered into the system. Therefore, our new /api/register route is very simple; it must simply pass the posted data to the userService for processing and report back when it has completed, ie:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"app.post('/api/register', (req, res) => {\n  userService\n    .registerUser(req.body)\n    .then((msg) => {\n      res.json({ message: msg });\n    })\n    .catch((msg) => {\n      res.status(422).json({ message: msg });\n    });\n});\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NOTE:")," The 422 error code communicates back to the client that the server understands the content type of the request and the syntax is correct but was unable to process the data (see: ",(0,a.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/422"},"422 Unprocessable Entity"),")."),(0,a.kt)("p",null,"To test this new route, stop and start your API (server.js) again and proceed to make the following request:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Make sure ",(0,a.kt)("strong",{parentName:"li"},"POST")," is selected in the request type dropdown"),(0,a.kt)("li",{parentName:"ul"},'In the address bar, type: "http://localhost:8080/api/register"'),(0,a.kt)("li",{parentName:"ul"},"In the ",(0,a.kt)("strong",{parentName:"li"},"Headers"),' tab, ensure that "Content-Type" is selected with a value of "application/json"'),(0,a.kt)("li",{parentName:"ul"},"In the ",(0,a.kt)("strong",{parentName:"li"},"Body"),' tab, copy and paste our information for user "bob" in the provided text area:')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": "bob",\n  "password": "myPassword",\n  "password2": "myPassword",\n  "fullName": "Robert Wiley",\n  "role": "administrator"\n}\n')),(0,a.kt)("p",null,"Once the request is processed, it should return with a status 200 and the JSON:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "message": "User bob successfully registered"\n}\n')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"New Route: /api/login")),(0,a.kt)("p",null,"In addition to ",(0,a.kt)("strong",{parentName:"p"},"adding")," users to the system, we must also be able to ",(0,a.kt)("strong",{parentName:"p"},"authenticate"),' users and allow them to "login" before being granted access to the data. In this case, all of the work required for authenticating user data is done in the "dataAuth.checkUser()" method. So (like "/api/register"), our "/api/login" route, will once again pass the posted data to the userService for processing and report back when it has completed, ie:'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"app.post('/api/login', (req, res) => {\n  userService\n    .checkUser(req.body)\n    .then((user) => {\n      res.json({ message: 'login successful' });\n    })\n    .catch((msg) => {\n      res.status(422).json({ message: msg });\n    });\n});\n")),(0,a.kt)("p",null,"To test this new route, once again stop and start your API (server.js) and make another request. We will keep most of the values the same, with the following exceptions:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},'In the address bar, type: "http://localhost:8080/api/login"'),(0,a.kt)("li",{parentName:"ul"},"In the ",(0,a.kt)("strong",{parentName:"li"},"Body"),' tab, copy and paste our information for user "bob" in the provided text area:')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "userName": "bob",\n  "password": "myPassword"\n}\n')),(0,a.kt)("p",null,"Again, when you're sure you've entered everything correctly and your server is running, hit the blue ",(0,a.kt)("strong",{parentName:"p"},"Send")," button to send the POST data to the API."),(0,a.kt)("p",null,"Once the request is processed, it should return with a status 200 and the JSON:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "message": "login successful"\n}\n')),(0,a.kt)("p",null,'You can also try entering incorrect credentials in the request body (ie: a different "userName", or an incorrect "password") to verify that our service is indeed functioning properly and will not send the "login successful" message to unauthorized users.'))}h.isMDXComponent=!0},8209:(e,t,n)=>{n(7294)}}]);